<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>六年级家长开放日选课程序（云端版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <main class="max-w-4xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">六年级家长开放日选课程序（云端版）</h1>
      <p class="text-sm text-gray-600 mt-1">每个分层限额 8，信息保存于 Firebase。</p>
    </header>

    <form id="signupForm" class="bg-white p-6 rounded-lg shadow space-y-5">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <label>
          <span class="text-sm font-medium">学生姓名</span>
          <input id="studentName" required class="mt-1 w-full border rounded p-1 border-gray-300 focus:ring-blue-500 focus:border-blue-500" />
        </label>
        <label>
          <span class="text-sm font-medium">班级</span>
          <select id="classNumber" required class="mt-1 w-full border rounded p-1">
            <option value="" disabled selected>选择班级</option>
            <option value="1">六年级1班</option>
            <option value="2">六年级2班</option>
            <option value="3">六年级3班</option>
            <option value="4">六年级4班</option>
            <option value="5">六年级5班</option>
          </select>
        </label>
        <fieldset>
          <legend class="text-sm font-medium">选择日期</legend>
          <div class="flex gap-3 mt-1">
            <label><input type="radio" name="day" value="english" required> 英语 11月11日</label>
            <label><input type="radio" name="day" value="math"> 数学 11月14日</label>
          </div>
        </fieldset>
      </div>

      <fieldset id="trackFieldset">
        <legend class="text-sm font-medium mt-3">分层选项（每班限额8）</legend>
        <div id="trackOptions" class="mt-2 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
          <p class="text-gray-500 text-sm col-span-full">请选择班级和日期以加载分层。</p>
        </div>
      </fieldset>

      <label class="flex items-center gap-2 text-sm">
        <input id="agree" type="checkbox" required class="text-blue-600" />
        我已确认所选分层与孩子实际分层一致。
      </label>

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        提交报名
      </button>
    </form>

    <section id="message" class="hidden mt-4 p-4 rounded border text-sm"></section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyALbRZ6P-azQhY55YUbyC-Np6zewqb2WdY",
      authDomain: "opening-day-a4824.firebaseapp.com",
      databaseURL: "https://opening-day-a4824-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "opening-day-a4824",
      storageBucket: "opening-day-a4824.firebasestorage.app",
      messagingSenderId: "827603104559",
      appId: "1:827603104559:web:ad7e69bb5a67bf0d1f67da",
      measurementId: "G-NB24HMQVL9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const signupsRef = db.ref("signups");

    const TRACKS = {
      english: {A: ["ESL", "R/F.a", "R/F.b", "H"], B: ["ESL", "R/F", "H"]},
      math: {A: ["S1", "S2", "H"], B: ["S", "H"]}
    };

    const DAY_LABELS = {english: "英语 11月11日", math: "数学 11月14日"};

    const form = document.getElementById('signupForm');
    const trackContainer = document.getElementById('trackOptions');
    const msgEl = document.getElementById('message');

    let currentCounts = {};

    signupsRef.on("value", snap => {
      const data = snap.val();
      currentCounts = {};
      if (data) {
        Object.values(data).forEach(r => {
          const key = `${r.day}_${r.classNumber}_${r.track}`;
          currentCounts[key] = (currentCounts[key] || 0) + 1;
        });
      }
      renderTracks();
    });

    function getGroup(cn) {
      const n = Number(cn);
      if ([1,2,3].includes(n)) return 'A';
      if ([4,5].includes(n)) return 'B';
      return null;
    }

    function remaining(day, classNum, track) {
      return 8 - (currentCounts[`${day}_${classNum}_${track}`] || 0);
    }

    function renderTracks() {
      const classNum = document.getElementById('classNumber').value;
      const day = form.day.value;
      trackContainer.innerHTML = '';
      if (!classNum || !day) {
        trackContainer.innerHTML = '<p class="text-gray-500 text-sm col-span-full">请选择班级和日期以显示分层。</p>';
        return;
      }
      const group = getGroup(classNum);
      const options = TRACKS[day]?.[group] || [];
      options.forEach(t => {
        const remain = remaining(day, classNum, t);
        const disabled = remain <= 0 ? 'disabled' : '';
        trackContainer.innerHTML += `
          <label class="flex justify-between px-3 py-2 border rounded ${remain<=0?'opacity-60':''}">
            <div><input type="radio" name="track" value="${t}" required ${disabled}> ${t}</div>
            <div class="text-xs ${remain>0?'text-green-700':'text-red-600'}">${remain>0?'剩余 '+remain+'/8':'已满'}</div>
          </label>`;
      });
    }

    document.querySelectorAll('input[name="day"]').forEach(el => el.addEventListener('change', renderTracks));
    document.getElementById('classNumber').addEventListener('change', renderTracks);

    form.addEventListener('submit', e => {
      e.preventDefault();
      const name = document.getElementById('studentName').value.trim();
      const classNumber = document.getElementById('classNumber').value;
      const day = form.day.value;
      const track = form.track.value;
      const remain = remaining(day, classNumber, track);

      if (remain <= 0) {
        alert('该分层已满，请选择其他。');
        return;
      }

      const signup = {
        studentName: name,
        classNumber,
        day,
        track,
        timestamp: new Date().toISOString()
      };

      signupsRef.push(signup)
        .then(() => {
          msgEl.className = "mt-4 p-4 rounded border border-green-300 bg-green-50 text-green-800";
          msgEl.textContent = "报名成功！您的信息已提交。";
          msgEl.classList.remove('hidden');
          form.reset();
          renderTracks();
        })
        .catch(err => {
          msgEl.className = "mt-4 p-4 rounded border border-red-300 bg-red-50 text-red-800";
          msgEl.textContent = "提交失败：" + err.message;
          msgEl.classList.remove('hidden');
        });
    });
  </script>
</body>
</html>
